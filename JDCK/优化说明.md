# Quan X 脚本优化说明 (v1.0.2)

## 🎯 优化目标

解决打开京东 App 时脚本不停同步 Cookie 的问题，减少不必要的网络请求和日志输出。

## 📊 问题分析

### 原有逻辑的问题

1. **每次请求都触发**：只要访问 `api.m.jd.com`，脚本就会执行
2. **频繁验证**：即使 Cookie 未变化，也会调用京东验证接口
3. **缺少冷却时间**：没有时间间隔控制，导致短时间内重复执行

### 实际影响

- 打开京东 App 时会触发多次请求到 `api.m.jd.com`
- 每次请求都会执行 Cookie 验证和同步逻辑
- 产生大量日志输出和网络请求
- 即使 Cookie 完全没有变化也会重复验证

## ✨ 优化方案

### 核心改进：冷却机制

添加了**时间戳缓存**和**冷却时间**机制：

1. **记录上次同步时间**：每次成功验证或同步后记录时间戳
2. **设置冷却期**：默认 5 分钟，可自定义配置
3. **快速路径**：Cookie 未变化且在冷却期内，直接跳过所有检查

### 优化后的执行流程

```
捕获 Cookie
    ↓
检查本地缓存
    ↓
Cookie 未变化 且 在冷却期内？
    ├─ 是 → 直接跳过（无任何网络请求）✅
    └─ 否 → 继续检查
              ↓
         Cookie 变化了？
              ├─ 是 → 验证 + 同步
              └─ 否 → 仅验证
                       ↓
                  Cookie 有效？
                       ├─ 是 → 更新时间戳，跳过同步
                       └─ 否 → 执行同步
```

## 🔧 配置说明

### 方式一：直接修改脚本

```javascript
const MANUAL_CONFIG = {
    url: "http://192.168.1.1:5700",
    id: "your_client_id",
    secret: "your_client_secret",
    cooldown: 5  // 冷却时间（分钟），可自定义
};
```

### 方式二：使用 BoxJS

在 BoxJS 配置中添加"冷却时间（分钟）"参数，默认值为 5。

## 📈 性能提升

### 优化前

```
打开京东 App
  → 触发 10 次 api.m.jd.com 请求
  → 执行 10 次验证逻辑
  → 产生大量日志
  → 可能发送多次通知
```

### 优化后

```
打开京东 App（首次）
  → 触发 1 次验证
  → 记录时间戳
  
打开京东 App（5分钟内）
  → 完全跳过，无任何请求 ✅
  
打开京东 App（5分钟后）
  → 触发 1 次验证
  → Cookie 有效则只更新时间戳
  → Cookie 失效才执行同步
```

## 🎯 使用场景

### 场景 1：频繁打开京东 App

**优化前**：每次打开都会验证和同步，产生大量请求  
**优化后**：5 分钟内只验证一次，其余时间完全跳过

### 场景 2：Cookie 长期有效

**优化前**：每次都验证，即使 Cookie 一直有效  
**优化后**：每 5 分钟验证一次，确认有效后直接跳过

### 场景 3：Cookie 失效或变化

**优化前**：立即同步  
**优化后**：立即同步（行为不变）

## 📝 日志示例

### 在冷却期内（完全跳过）

```
[JD Cookie Sync] Captured Cookie for pt_pin=xxx
[JD Cookie Sync] Cookie unchanged for xxx, within cooldown period (3min remaining). Skip all checks.
```

### 超过冷却期（仅验证）

```
[JD Cookie Sync] Captured Cookie for pt_pin=xxx
[JD Cookie Sync] Cookie unchanged for xxx, but cooldown expired. Validating...
[JD Cookie Sync] Cookie validation success: 用户昵称
[JD Cookie Sync] Cookie valid for xxx (用户昵称). Update timestamp and skip sync.
```

### Cookie 变化（验证+同步）

```
[JD Cookie Sync] Captured Cookie for pt_pin=xxx
[JD Cookie Sync] Cookie changed for xxx. Need to validate and sync.
[JD Cookie Sync] Cookie validation success: 用户昵称
[JD Cookie Sync] Cookie valid and changed for xxx (用户昵称). Need to sync.
[通知] Cookie已更新
```

## ⚙️ 自定义冷却时间

根据使用习惯调整冷却时间：

- **频繁使用京东**：建议 3-5 分钟
- **偶尔使用京东**：建议 10-15 分钟
- **很少使用京东**：建议 30-60 分钟

## 🔍 技术细节

### 缓存键设计

```javascript
// Cookie 缓存
JD_COOKIE_CACHE_{pt_pin}

// 时间戳缓存
JD_COOKIE_TIMESTAMP_{pt_pin}
```

### 时间计算

```javascript
const cooldownMs = cooldown_minutes * 60 * 1000;
const timeSinceLastSync = currentTime - lastSyncTime;

if (timeSinceLastSync < cooldownMs) {
    // 在冷却期内，跳过
}
```

## 📌 注意事项

1. **首次使用**：没有缓存时间戳，会立即执行验证
2. **Cookie 变化**：无论冷却时间，都会立即同步
3. **Cookie 失效**：无论冷却时间，都会立即同步
4. **清除缓存**：如果清除了 Quantumult X 的数据，会重置冷却时间

## 🎉 总结

通过添加冷却机制，成功解决了频繁同步的问题：

✅ 大幅减少网络请求（减少 90% 以上）  
✅ 减少日志输出，提升性能  
✅ 避免频繁通知打扰  
✅ 保持 Cookie 有效性检查  
✅ 不影响 Cookie 变化时的及时同步  

---

**版本**: v1.0.2  
**更新日期**: 2026-02-09  
**作者**: z.W.
